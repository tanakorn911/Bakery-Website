<!-- templates/order_detail.html -->
{% extends "layout.html" %}

{% block title %}รายละเอียดคำสั่งซื้อ #{{ order.id }} - Sweet Dreams Bakery{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Order Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-1">คำสั่งซื้อ #{{ order.id }}</h3>
                            <p class="mb-0">วันที่สั่งซื้อ: {{ order.created_at }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-{{ 'success' if order.status == 'completed' else 'warning' }} fs-6">
                                {{ order.status }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Order Items -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">รายการสินค้า</h5>
                </div>
                <div class="card-body">
                    {% for item in order_items %}
                    <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
                        <div class="me-3">
                            <img src="{{ url_for('static', filename='images/products/' + (item.product_image or 'placeholder.jpg')) }}" 
                                 alt="{{ item.product_name }}" 
                                 class="rounded" 
                                 style="width: 60px; height: 60px; object-fit: cover;">
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">{{ item.product_name }}</h6>
                            {% if item.options %}
                                <small class="text-muted">ตัวเลือก: {{ item.options }}</small><br>
                            {% endif %}
                            <small class="text-muted">
                                {{ item.quantity }} × {{ "%.0f"|format(item.unit_price) }} บาท
                            </small>
                        </div>
                        <div class="text-end">
                            <strong>{{ "%.0f"|format(item.total_price) }} บาท</strong>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Order Summary -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">สรุปการสั่งซื้อ</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>ยอดรวม:</span>
                        <span>{{ "%.0f"|format(order.total_amount) }} บาท</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>ค่าจัดส่ง:</span>
                        <span class="text-success">ฟรี</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>รวมทั้งหมด:</strong>
                        <strong class="text-primary">{{ "%.0f"|format(order.total_amount) }} บาท</strong>
                    </div>
                </div>
            </div>

            <!-- Customer Info -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ข้อมูลการจัดส่ง</h5>
                </div>
                <div class="card-body">
                    <p><strong>ชื่อผู้รับ:</strong> {{ order.customer_name }}</p>
                    <p><strong>เบอร์โทร:</strong> {{ order.customer_phone }}</p>
                    {% if order.customer_address %}
                        <p><strong>ที่อยู่:</strong><br>{{ order.customer_address }}</p>
                    {% endif %}
                    {% if order.notes %}
                        <p><strong>หมายเหตุ:</strong><br>{{ order.notes }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="/profile" class="btn btn-outline-primary me-2">
                <i class="fas fa-arrow-left me-1"></i>กลับไปโปรไฟล์
            </a>
            {% if order.status == 'pending' %}
            <button class="btn btn-outline-danger" onclick="cancelOrder({{ order.id }})">
                <i class="fas fa-times me-1"></i>ยกเลิกคำสั่งซื้อ
            </button>
            {% endif %}
            <button class="btn btn-success" onclick="reorder()">
                <i class="fas fa-redo me-1"></i>สั่งซื้ออีกครั้ง
            </button>
        </div>
    </div>
</div>

<script>
function cancelOrder(orderId) {
    if (confirm('คุณต้องการยกเลิกคำสั่งซื้อนี้หรือไม่?')) {
        $.post(`/cancel_order/${orderId}`, function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert(response.message);
            }
        });
    }
}

function reorder() {
    if (confirm('คุณต้องการเพิ่มสินค้าเหล่านี้ลงตะกร้าหรือไม่?')) {
        $.post('/reorder/{{ order.id }}', function(response) {
            if (response.success) {
                alert('เพิ่มสินค้าลงตะกร้าแล้ว');
                window.location.href = '/cart';
            } else {
                alert(response.message);
            }
        });
    }
}
</script>
{% endblock %}