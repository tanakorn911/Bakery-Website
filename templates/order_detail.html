{% extends "layout.html" %}
{% block title %}รายละเอียดคำสั่งซื้อ #{{ order.id }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/order_detail.css')}}">
{% endblock %}

{% block content %}
<div class="container py-5 order-detail-page">
    <h4>คำสั่งซื้อ #{{ order.id }}</h4>
    <p>วันที่: {{ order.created_at | to_bangkok }} | สถานะ: 
        <span id="order-status" class="badge
            {% if order.status == 'pending' %}bg-warning text-dark
            {% elif order.status == 'processing' %}bg-info text-white
            {% elif order.status == 'completed' %}bg-success text-white
            {% elif order.status == 'cancelled' %}bg-danger text-white
            {% endif %}
        ">
            {% if order.status == 'pending' %}รอดำเนินการ
            {% elif order.status == 'processing' %}กำลังจัดเตรียม
            {% elif order.status == 'completed' %}เสร็จสิ้น
            {% elif order.status == 'cancelled' %}ยกเลิกแล้ว
            {% endif %}
        </span>
    </p>

    <h5 class="mt-4">ข้อมูลผู้รับ</h5>
    <p>
        ชื่อ: {{ order.customer_name }}<br>
        เบอร์โทร: {{ order.customer_phone }}<br>
        ที่อยู่: {{ addr.full_address or 'ไม่ระบุ' }}<br>
        หมายเหตุ: {{ order.notes or '-' }}
    </p>

    <h5 class="mt-4">รายการสินค้า</h5>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>สินค้า</th>
                <th>ราคา/หน่วย</th>
                <th>จำนวน</th>
                <th>รวม</th>
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ item.product_name }}</td>
                <td>{{ "%.2f"|format(item.unit_price) }} บาท</td>
                <td>{{ item.quantity }}</td>
                <td>{{ "%.2f"|format(item.total_price) }} บาท</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th colspan="3" class="text-end">รวมทั้งหมด</th>
                <th>{{ "%.2f"|format(order.total_amount) }} บาท</th>
            </tr>
        </tfoot>
    </table>

    <div class="d-flex justify-content-between mt-3">
        <!-- ปุ่มกลับซ้าย -->
        <a href="{{ url_for('order_history') }}" class="btn btn-secondary">
            กลับ
        </a>

        <!-- ปุ่มยกเลิกขวา -->
        {% if order.status == 'pending' %}
        <form id="cancel-all-form" action="{{ url_for('cancel_order', order_id=order.id) }}">
            <button type="submit" class="btn btn-danger btn-sm">
                <i class="fas fa-trash-alt me-1"></i>ยกเลิกคำสั่งซื้อ
            </button>
        </form>
        {% endif %}
    </div>
</div>

<script>
document.getElementById('cancel-all-form')?.addEventListener('submit', function(e) {
    e.preventDefault();

    if(!confirm('คุณแน่ใจว่าจะยกเลิกคำสั่งซื้อทั้งหมด?')) return;

    fetch(this.action, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_id: {{ order.id }} }),
        credentials: 'same-origin'
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);
        if(data.success){
            // อัปเดต badge ทันที
            const badge = document.getElementById('order-status');
            badge.textContent = 'ยกเลิกแล้ว';
            badge.className = 'badge bg-danger text-white';
            // ซ่อนปุ่มยกเลิก
            document.getElementById('cancel-all-form').style.display = 'none';
        }
    })
    .catch(err => alert('เกิดข้อผิดพลาด: ' + err));
});
</script>
{% endblock %}